#! Check for correctness of ESP values. The ESP values are calculated using one or four threads
#! The one thread values are checked against the four thread values. The one thread values are 
#! also checked against the reference values (1 thread values computed, when generating this test).
#! Caution: The reference values are not obtained using an actual physical reference, but rather
#! generated by Psi4 at one point in time.

import psi4
import psi4.core as p4c
import numpy as np

psi4.set_output_file("output.dat", False)

#H2O with minimal basis
h2o = psi4.geometry("""
O
H 1 0.96
H 1 0.96 2 104.5
""")


ene, wfn = psi4.energy('scf/STO-3G', return_wfn = True)
myepc = p4c.ESPPropCalc(wfn)

# Number of points to evaluate the ESP on per dimension (reference values below were generated with 5)
numpoints_per_dim = 5
points = np.array([ [float(x),float(y),float(z) ] for x in range(0,numpoints_per_dim) for y in range(0,numpoints_per_dim) for z in range(0,numpoints_per_dim) ])
psi4_matrix = p4c.Matrix.from_array(points)

# We calculate the ESPs with 1 thread
psi4.set_num_threads(1, quiet = True)
esps_1threads = np.array(myepc.compute_esp_over_grid_in_memory(psi4_matrix))
# We calculate the ESPs with 4 threads
psi4.set_num_threads(4, quiet = True)
esps_4threads = np.array(myepc.compute_esp_over_grid_in_memory(psi4_matrix))

# Reference values (Generated with psi4 master on 22.05.20 at 23:30 GMT
reference_esps = [ 4.62483342e+01,  1.54804313e-01,  4.13685593e-02,  1.99074762e-02,
                   1.15152678e-02,  2.05265305e-01,  2.83124071e-01,  3.85914212e-02,
                   1.81738886e-02,  1.07752887e-02,  1.77818258e-02,  3.68574105e-02,
                   2.25974306e-02,  1.35771735e-02,  8.87906889e-03,  5.10066439e-03,
                   1.12829223e-02,  1.12265555e-02,  8.83213803e-03,  6.63860586e-03,
                   2.19102261e-03,  4.93006854e-03,  5.89615996e-03,  5.53808484e-03,
                   4.71886332e-03, -5.17239329e-02,  3.13726711e-02,  2.75355388e-02,
                   1.65919492e-02,  1.03990059e-02, -3.35874097e-03,  4.15222788e-02,
                   2.56191309e-02,  1.52660739e-02,  9.76796362e-03,  6.32834557e-03,
                   2.04241605e-02,  1.70973880e-02,  1.17455466e-02,  8.13966708e-03,
                   3.38098123e-03,  8.74425646e-03,  9.48996966e-03,  7.93026739e-03,
                   6.17969093e-03,  1.74806282e-03,  4.26579485e-03,  5.29784951e-03,
                   5.12333890e-03,  4.45846711e-03, -1.57567665e-02,  5.30695677e-03,
                   1.23293022e-02,  1.06586884e-02,  7.93900611e-03, -7.73802957e-03,
                   7.26178250e-03,  1.17147293e-02,  9.98332008e-03,  7.52680394e-03,
                  -4.70874042e-04,  7.07678716e-03,  9.28214077e-03,  8.16156593e-03,
                   6.44348860e-03,  1.00781695e-03,  4.75096863e-03,  6.24946368e-03,
                   5.97476305e-03,  5.07885832e-03,  9.07850148e-04,  2.91174728e-03,
                   3.98405846e-03,  4.14293807e-03,  3.80513995e-03, -5.01856357e-03,
                   1.66005706e-03,  5.58988126e-03,  6.25608633e-03,  5.51718510e-03,
                  -3.54538877e-03,  2.13874136e-03,  5.42317564e-03,  5.96499476e-03,
                   5.28687977e-03, -1.26041313e-03,  2.57086533e-03,  4.76216983e-03,
                   5.15904477e-03,  4.66727597e-03, -6.98718627e-05,  2.29543121e-03,
                   3.72078488e-03,  4.09219098e-03,  3.84409282e-03,  2.86099206e-04,
                   1.74337099e-03,  2.70404545e-03,  3.07010847e-03,  3.01768294e-03,
                  -2.17493011e-03,  7.08011269e-04,  2.82422496e-03,  3.69989978e-03,
                   3.71459579e-03, -1.77325890e-03,  8.55302891e-04,  2.77277336e-03,
                   3.57535348e-03,  3.59320794e-03, -9.75050076e-04,  1.08091443e-03,
                   2.57027134e-03,  3.22234880e-03,  3.25925100e-03, -3.45599629e-04,
                   1.12615341e-03,  2.20372521e-03,  2.71976417e-03,  2.79365593e-03,
                  -1.83114358e-05,  1.00066735e-03,  1.76948007e-03,  2.18338059e-03,
                   2.29358229e-03]

# Comparison
psi4.compare_arrays(esps_1threads, esps_4threads, 3, "Reference value for ESP calculation, 1 thread vs. 4 threads.")
psi4.compare_arrays(esps_1threads, reference_esps, 3, "Reference value for ESP calculation, 1 thread vs. reference calculation.")

# We calculate the EF with 1 thread
psi4.set_num_threads(1, quiet = True)
efs_1threads = np.array(myepc.compute_field_over_grid_in_memory(psi4_matrix))

# # We calculate the EF with 4 threads
psi4.set_num_threads(4, quiet = True)
efs_4threads = np.array(myepc.compute_field_over_grid_in_memory(psi4_matrix))

# Reference fields (Generated with psi4 master (#6491598) on 14.11.20 at 13:31 GMT)
reference_efs = [[ 0.0000000000,  0.0000000000,  477.1861057945],
                 [ 0.0000000000,  0.0000000000,  0.1856238322],
                 [ 0.0000000000,  0.0000000000,  0.0191346393],
                 [ 0.0000000000, -0.0000000000,  0.0065558845],
                 [ 0.0000000000,  0.0000000000,  0.0029433729],
                 [ 0.0000000000,  0.2956911826, -0.4534222141],
                 [ 0.0000000000,  0.2679473628,  0.5284303444],
                 [ 0.0000000000,  0.0058888925,  0.0206451109],
                 [ 0.0000000000,  0.0018341620,  0.0057656557],
                 [ 0.0000000000,  0.0007549315,  0.0026253010],
                 [ 0.0000000000,  0.0157991091, -0.0211018928],
                 [ 0.0000000000,  0.0297891090,  0.0047829789],
                 [ 0.0000000000,  0.0081954456,  0.0065931352],
                 [ 0.0000000000,  0.0027283164,  0.0033370310],
                 [ 0.0000000000,  0.0011724848,  0.0018264882],
                 [ 0.0000000000,  0.0026362050, -0.0045865957],
                 [ 0.0000000000,  0.0056890390, -0.0014655807],
                 [ 0.0000000000,  0.0040635624,  0.0010313815],
                 [ 0.0000000000,  0.0021585189,  0.0012992875],
                 [ 0.0000000000,  0.0011372270,  0.0010034845],
                 [ 0.0000000000,  0.0008561112, -0.0017682632],
                 [ 0.0000000000,  0.0018927123, -0.0010058439],
                 [ 0.0000000000,  0.0018751800, -0.0000748722],
                 [ 0.0000000000,  0.0013571896,  0.0003713235],
                 [ 0.0000000000,  0.0008804393,  0.0004583090],
                 [ 0.0362842257,  0.0000000000, -0.0694384092],
                 [ 0.0365964119,  0.0000000000, -0.0112411484],
                 [ 0.0103445436,  0.0000000000,  0.0068698037],
                 [ 0.0030120007, -0.0000000000,  0.0043984008],
                 [ 0.0010848784,  0.0000000000,  0.0023728654],
                 [ 0.0253196892, -0.0205081091, -0.0397198780],
                 [ 0.0470813911,  0.0048780416,  0.0040014525],
                 [ 0.0095033721,  0.0029730901,  0.0074432321],
                 [ 0.0026534352,  0.0013920356,  0.0039002555],
                 [ 0.0009817477,  0.0006445436,  0.0021267589],
                 [ 0.0066694069,  0.0014915658, -0.0114121175],
                 [ 0.0105952191,  0.0096815254, -0.0015155226],
                 [ 0.0045729094,  0.0049207757,  0.0031224904],
                 [ 0.0017136000,  0.0021293741,  0.0023693607],
                 [ 0.0007272245,  0.0010141372,  0.0015040203],
                 [ 0.0014391655,  0.0012248499, -0.0037095210],
                 [ 0.0022074434,  0.0036294900, -0.0015841083],
                 [ 0.0016003638,  0.0030254347,  0.0004958609],
                 [ 0.0008720500,  0.0017927095,  0.0009711731],
                 [ 0.0004573186,  0.0010072763,  0.0008447258],
                 [ 0.0004125098,  0.0005756382, -0.0015861224],
                 [ 0.0006309835,  0.0014770364, -0.0009700760],
                 [ 0.0005810333,  0.0015598261, -0.0001603940],
                 [ 0.0004115933,  0.0011877544,  0.0002757228],
                 [ 0.0002628406,  0.0007995465,  0.0003918564],
                 [-0.0114301361, -0.0000000000, -0.0107695979],
                 [ 0.0039082929, -0.0000000000, -0.0081555599],
                 [ 0.0054180089,  0.0000000000, -0.0003535299],
                 [ 0.0028837030, -0.0000000000,  0.0014715433],
                 [ 0.0013838799, -0.0000000000,  0.0013016938],
                 [-0.0030969746, -0.0057745574, -0.0083712733],
                 [ 0.0054856759, -0.0010417903, -0.0055094528],
                 [ 0.0049921055,  0.0007857195,  0.0000284552],
                 [ 0.0025997841,  0.0007041203,  0.0013373591],
                 [ 0.0012697764,  0.0004225439,  0.0011803822],
                 [ 0.0012829638, -0.0018555287, -0.0046356024],
                 [ 0.0040014468,  0.0010321229, -0.0026894267],
                 [ 0.0032852574,  0.0016331515,  0.0000508656],
                 [ 0.0018566743,  0.0011452997,  0.0008896087],
                 [ 0.0009825663,  0.0006867790,  0.0008662462],
                 [ 0.0009145787, -0.0001323472, -0.0023054007],
                 [ 0.0017613284,  0.0011897739, -0.0014471278],
                 [ 0.0016202087,  0.0014496755, -0.0002092184],
                 [ 0.0010878488,  0.0011012916,  0.0003890794],
                 [ 0.0006585317,  0.0007227965,  0.0005103146],
                 [ 0.0004166874,  0.0001385411, -0.0011989365],
                 [ 0.0007167626,  0.0007558379, -0.0008475398],
                 [ 0.0007362632,  0.0009527295, -0.0002945137],
                 [ 0.0005800553,  0.0008254033,  0.0000849291],
                 [ 0.0004037703,  0.0006110590,  0.0002428189],
                 [-0.0025493085, -0.0000000000, -0.0034284009],
                 [ 0.0008593876, -0.0000000000, -0.0030972298],
                 [ 0.0021880151, -0.0000000000, -0.0010641887],
                 [ 0.0017832097,  0.0000000000,  0.0001679411],
                 [ 0.0011324138,  0.0000000000,  0.0005169765],
                 [-0.0014067465, -0.0012889767, -0.0030072501],
                 [ 0.0011860216, -0.0003742239, -0.0025919672],
                 [ 0.0020770699,  0.0002023179, -0.0008895877],
                 [ 0.0016503559,  0.0003036989,  0.0001601464],
                 [ 0.0010563132,  0.0002373193,  0.0004741547],
                 [-0.0000513563, -0.0009545536, -0.0021312477],
                 [ 0.0012836628, -0.0000247145, -0.0017059527],
                 [ 0.0016379677,  0.0004853614, -0.0006161960],
                 [ 0.0012936792,  0.0005252122,  0.0001038631],
                 [ 0.0008593273,  0.0004010315,  0.0003591256],
                 [ 0.0002939449, -0.0003519349, -0.0013487069],
                 [ 0.0008904115,  0.0002640347, -0.0010565261],
                 [ 0.0010465684,  0.0005753053, -0.0004474042],
                 [ 0.0008701864,  0.0005747024,  0.0000100362],
                 [ 0.0006202944,  0.0004515480,  0.0002172949],
                 [ 0.0002370819, -0.0000724050, -0.0008317917],
                 [ 0.0005034001,  0.0002912360, -0.0006665301],
                 [ 0.0005933331,  0.0004837150, -0.0003429381],
                 [ 0.0005311048,  0.0004936546, -0.0000625231],
                 [ 0.0004118422,  0.0004124578,  0.0000985127],
                 [-0.0008428198, -0.0000000000, -0.0014946041],
                 [ 0.0002792955,  0.0000000000, -0.0014194235],
                 [ 0.0009380382,  0.0000000000, -0.0007812270],
                 [ 0.0009922582,  0.0000000000, -0.0001873179],
                 [ 0.0007814109,  0.0000000000,  0.0001272875],
                 [-0.0005971258, -0.0003797553, -0.0013791062],
                 [ 0.0003630612, -0.0001310220, -0.0012852130],
                 [ 0.0009083621,  0.0000607419, -0.0007108178],
                 [ 0.0009378472,  0.0001303547, -0.0001747193],
                 [ 0.0007398695,  0.0001257500,  0.0001161834],
                 [-0.0001829533, -0.0004092950, -0.0011054124],
                 [ 0.0004523623, -0.0000818712, -0.0009923159],
                 [ 0.0007897665,  0.0001554704, -0.0005614079],
                 [ 0.0007873939,  0.0002360945, -0.0001527337],
                 [ 0.0006292239,  0.0002202229,  0.0000847326],
                 [ 0.0000444810, -0.0002484249, -0.0008068007],
                 [ 0.0004075583,  0.0000306044, -0.0007059447],
                 [ 0.0005946178,  0.0002225645, -0.0004202694],
                 [ 0.0005891437,  0.0002848723, -0.0001387048],
                 [ 0.0004857326,  0.0002635600,  0.0000421765],
                 [ 0.0000979431, -0.0001090665, -0.0005634073],
                 [ 0.0002945431,  0.0000913557, -0.0004906537],
                 [ 0.0003997931,  0.0002277640, -0.0003138910],
                 [ 0.0004037996,  0.0002748554, -0.0001297225],
                 [ 0.0003480158,  0.0002591401,  0.0000026505],
                 ]

# Comparison
psi4.compare_arrays(efs_1threads, efs_4threads, 9, "Reference value for EF calculation, 1 thread vs. 4 threads.")
psi4.compare_arrays(efs_1threads, reference_efs, 9, "Reference value for EF calculation, 1 thread vs. reference calculation.")
